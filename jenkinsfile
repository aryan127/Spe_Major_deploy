pipeline {
  agent any

  stages {
    stage('Git Pull') {
        environment {
                IMAGE_NAME=''
        }
        steps {
            git url: 'https://github.com/aryan127/placement-backend.git'   
        }
        steps {
            script {
                IMAGE_NAME=docker.build "aryan1207/spe_backend"
                docker.withRegistry('','docker-key'){
                IMAGE_NAME.push()
            }
          
        }


        }
    }
    stage('Git Pull') {
        steps {
            git url: 'https://github.com/akashanand842/RecipeMedia-SPEMajor.git'
        }
    }

    stage('Build and Push Frontend Image') {
      environment {
        IMAGE_NAME = ''
      }
      steps {
        dir('client') {
          script {
            IMAGE_NAME=docker.build "akashanand842/recipe-frontend"
            docker.withRegistry('','docker-key'){
                IMAGE_NAME.push()
            }
          }
        }
      }
    }

    stage('Build and Push Backend Image') {
      environment {
        IMAGE_NAME = ''
      }
      steps {
        dir('server') {
          script {
            IMAGE_NAME=docker.build "akashanand842/recipe-backend"
            docker.withRegistry('','docker-key'){
                IMAGE_NAME.push()
            }
          }
        }
      }
    }

    stage('Deploy with Ansible') {
      steps {
        script{
          sh 'ansible-playbook ansible-deploy/ansible-book.yml -i ansible-deploy/inventory --user akash --extra-vars "ansible_become_pass=123"'
        }
      }
    }
  }
}